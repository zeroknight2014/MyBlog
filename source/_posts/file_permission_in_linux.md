---
title: linux下文件权限和安全
date: 2016-05-27 20:56:34
keywords: linux 权限 安全
tags: linux
category: linux
description: <!--more-->
---


# linux下文件权限和安全


## linux下文件的创建

创建一个文件时，系统保存了有关该文件的全部信息，包括： 
1.文件位置 
2.文件大小 
3.文件类型 
4.文件所有者，所有组 
5.i节点 
6.文件修改时间 
7.文件的权限位

touch命令创建文件temp

> $touch temp


## linux下查看文件的相关信息

ls或者stat

> ls -l temp 
> -rw-r–r– 1 root root 0 10月 19 20:16 temp

从左至右每项的含义分别是： 
**-rw-r–r–**：代表文件的权限位（读写执行等） 
**1**：表示该文件或目录下的总目录数目，这个数目=隐藏目录+普通目录。如果文件是目录文件，则最少有.和..两个隐藏目录。如果是文件，该值应该是1；如果是目录，则其值至少是2\. 
**root**：文件属主，即所有者。 
**root**：文件属组（一般是文件属主所在的默认用户组。） 
**0**：字节来表示的文件长度，记住，默认单位是字节B，不是KB！ 
**10月 19 20:17**：文件的更新时间。 
**temp**：文件名。


## linux下文件的权限位相关概念

-rw-r–r–中 
第一个-：代表文件的类型 
前三位rw-: 文件属主的权限 
中间三位r–: 文件属组的权限 
后三位r–: 其他用户拥有的权限

文件类型包括： 
-：普通文件，或者更准确地说，不属于以上几种类型的文件。 
l：符号链接文件 
d：目录文件 
s：套接字文件 
c：字符设备文件 
b：块设备文件 
p：命名管道设备设备文件


## 文件权限位设置命令chmod：

chmod命令的符号模式的格式为： 
>chmod [who] operator [permission] filename

**who的符号模式表：**

| who | 用户类型 | 说明 |
| --- | --- | --- |
| u | user | 文件所有者 |
| g | group | 文件所有者所在组 |
| o | other | 所有其他用户 |
| a | all | 所有用户 |

**operator的符号模式表：**

| Operator | 说明 |
| --- | --- |
| + | 增加权限 |
| - | 取消权限 |
| = | 设定权限 |

**permission的符号模式表：**

| 模式 | 名字 | 说明 |
| --- | --- | --- |
| r | 读 | 设置为可读权限 |
| w | 写 | 设置为可写权限 |
| x | 执行权限 | 设置为可执行权限 |
| X | 特殊执行权限 | 只有当文件为目录文件，或者其他类型的用户有可执行权限时，才将文件权限设置可执行 |
| s | set uid/gid | 当文件被执行时，根据who参数指定的用户类型设置文件的setuid或者setgid权限 |
| t | 粘滞位 | 设置粘贴位，只有超级用户可以设置该位，只有文件所有者u可以使用该位 |

给文件或目录加 SUID 和 SUID 的命令如下：


```
chmod u+s filename #设置SUID位
chmod u-s filename #去掉SUID设置
chmod g+s filename #设置SGID位
chmod g-s filename #去掉SGID设置
```

“t”代表了粘性位。如果在一个目录上出现“t”位，这就意味着该目录中的文件只有其属主才可以删除，即使某个属组用户具有和属主同等的权限。而文件的权限位出现t毫无意义，一般只用于目录。 
例：`drwxrwxrwt 31 root root 12288 10月 9 10:36 tmp`

系统的tmp目录下，任何人都有读写执行权限，那是不是任何人对里边的可写权限的文件就可以删除呢，当然不是了，这个就是粘滞位的做用，只有文件所有者或root用户才有权删除自已的文件。

粘滞位设置后，显示位置在其他用户的x位上，当其他用户的可执行权限位x存在时，用小写t表示；如果x不存在时，用大写T表示。 
SUID设置后，显示位置在用户的x位上。SGID设置后，显示在用户组的x位上。当SUID/SGID对应的权限位的可执行权限位x存在时，用小写s表示；如果x不存在时，则用大写S表示。


## linux下的目录和文件的权限位含义

| 文件权限 | 文件 | 目录 |
| --- | --- | --- |
| r | 读 | 可以列出该目录中的文件 |
| w | 写 | 可以在该目录中创建或删除文件 |
| x | 可执行 | 可以搜索或进入该目录 |
| - | 无 | 无 |

对于一个目录，如果设置了“read”标志，您可以列出目录的内容；“write”表示您可以在目 
录中创建文件，“execute”表示您可以进入该目录并访问内部的任何子目录。没有“execute” 
标志，目录内的文件系统对象是不可访问的。没有“read”标志，目录内的文件系统对象是不可查看的，但是只要有人知道磁盘上对象的完整路径，就仍然可以访问目录内的对象。



## chmod命令的八进制格式：

chmod [mode] filename 
mode为一个八进制数，每一个权限位就是一个八进制数。 
例如：chmod 0777 temp 
文件属主：r w x：4 + 2 + 1 
属组用户：r w x：4 + 2 + 1 
其他用户：r w x：4 + 2 + 1 
4个八进制数，对应12个二进制数，具体对应关系如下：

| 11 | 10 | 9 | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
| :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: |
| S | G | T | r | w | x | r | w | x | r | w | x |

第 11 位为 SUID 位，第 10 位为 SGID 位，第 9 位为 sticky 位(粘滞位)，第 8-0 位对应于上面的三组 rwx 位. 
例： 
100 111 110 100，八进制表示为4764，转换成符号模式为rwsrwr– 
010 111 110 100，八进制表示为2764，转换成符号模式为rwxrwSr– 
001 111 110 100，八进制表示为1764，转化为符号模式为rwxrw-r-T


## 权限掩码umask

umask用于设置用户创建文件的默认权限，并且设置的是权限”补码”。 
umask是chmod配套的，总共为4位（gid/uid,属主，组权，其它用户的权限）,不过通常用到的是后3个。 
默认情况下的umask值是022，此时你建立的文件默认权限是644(6-0,6-2,6-2)，建立的目录的默认权限是755(7-0,7-2,7-2)。


## 文件安全的更底层的权限

chmod只是改变文件的读写、执行权限，更底层的属性控制是由chattr来改变的。 
chattr命令的用法：chattr [ -RVf ] [ -v version ] [ mode ] files… 
[mode]部分是由+-=和[ASacDdIijsTtu]这些字符组合的，这部分是用来控制文件的 属性。

> A：文件或目录的 atime (access time)不可被修改(modified), 可以有效预防例如手提电脑磁盘I/O错误的发生。 
> S：硬盘I/O同步选项，功能类似sync。 
> a：即append，设定该参数后，只能向文件中添加数据，而不能删除，多用于服务器日志文件安全，只有root才能设定这个属性。 
> c：即compresse，设定文件是否经压缩后再存储。读取时需要经过自动解压操作。 
> d：即no dump，设定文件不能成为dump程序的备份目标。 
> i：设定文件不能被删除、改名、设定链接关系，同时不能写入或新增内容。i参数对于文件 系统的安全设置有很大帮助。 
> j：即journal，设定此参数使得当通过mount参数：data=ordered 或者 data=writeback 挂 载的文件系统，文件在写入时会先被记录(在journal中)。如果filesystem被设定参数为 data=journal，则该参数自动失效。 
> s：保密性地删除文件或目录，即硬盘空间被全部收回。 
> u：与s相反，当设定为u时，数据内容其实还存在磁盘中，可以用于undeletion。 
> e：该文件在磁盘块映射上使用了extents。 这里的extents我们可以理解成是一个连续的范围。这个属性是不能通过chattr去除的。



## SUID 和 SGID 详细解析（转）

由于 SUID 和 SGID 是在执行程序（程序的可执行位被设置）时起作用，而可执行位只对普通文件和目录文件有意义，所以设置其他种类文件的SUID和SGID位是没有多大意义的。

首先讲普通文件的 SUID 和 SGID 的作用:
如果普通文件 myfile 是属于 foo 用户的，是可执行的，现在没设 SUID 位，ls 命令显示如下： 
>-rwxr-xr-x 1 foo staff 7734 Apr 05 17:07 myfile

任何用户都可以执行这个程序。UNIX的内核是根据什么来确定一个进程对资源的访问权限的呢？是这个进程的运行用户的（有效）ID，包括user id和 group id。用户可以用id命令来查到自己的或其他用户的 user id 和 group id。除了一般的user id和group id外，还有两个称之为effective的id，就是有效id，上面的四个id表示为：uid，gid，euid，egid。内核主要是根据euid和egid来确定进程对资源的访问权限。一个进程如果没有SUID或SGID位，则euid=uid、egid=gid，分别是运行这个程序的用户的 uid 和 gid。

**例如:** 
kevin 用户的 uid 和 gid 分别为 204 和 202，foo 用户的 uid 和 gid 分别为 200 和 201，kevin 运行 myfile 程序形成的进程的 euid=uid=204，egid=gid=202，内核根据这些值来判断进程对资源访问的限制，其实就是 kevin 用户对资源访问的权限，和 foo 没关系。

如果一个程序设置了 SUID，则 euid 和 egid 变成被运行的程序的所有者的 uid 和 gid，例如 kevin 用户运行 myfile，euid=200，egid=201，uid=204，gid=202，则这个进程具有它的属主 foo 的资源访问权限。

**SUID 的作用就是这样：让本来没有相应权限的用户运行这个程序时，可以访问他没有权限访问的资源。** passwd 就是一个很鲜明的例子。 
SUID 的优先级比 SGID 高，当一个可执行程序设置了 SUID，则 SGID 会自动变成相应的 egid。

**下面讨论一个例子：** 
UNIX 系统有一个 /dev/kmem 的设备文件，是一个字符设备文件，里面存储了核心程序要访问的数据，包括用户的口令。所以这个文件不能给一般的用户读写，权限设为： 
>cr--r----- 1 root system 2, 1 May 25 1998 kmem

但 ps 等程序要读这个文件，而 ps 的权限设置如下： 
>-r-xr-sr-x 1 bin system 59346 Apr 05 1998 ps

这是一个设置了 SGID 的程序，而 ps 的用户是 bin，不是 root，所以不能设置 SUID 来访问 kmem，但大家注意了，bin 和 root 都属于 system 组，而且 ps 设置了 SGID，一般用户执行 ps，就会获得 system 组用户的权限，而文件 kmem 的同组用户的权限是可读，所以一般用户执行 ps 就没问题了。但有些人说，为什么不把 ps 程序设置为 root 用户的程序，然后设置 SUID 位，不也行吗？这的确可以解决问题，但实际中为什么不这样做呢？因为 SGID 的风险比 SUID 小得多，所以出于系统安全的考虑，应该尽量用 SGID 代替 SUID 的程序，如果可能的话。

下面来说明一下 SGID 对目录的影响。SUID 对目录没有影响。如果一个目录设置了 SGID 位，那么如果任何一个用户对这个目录有写权限的话，他在这个目录所建立的文件的组都会自动转为这个目录的属主所在的组，而文件所有者不变，还是属于建立这个文件的用户。

**为什么会引入SUID 和 SGID的概念呢？** 
首先看看这个问题：如果让每个用户更改自己的密码？ 
用户修改密码，是通过运行命令 passwd 来实现的。最终必须要修改 /etc/passwd 文件，而 passwd 的文件的属性是： 
>-rw-r--r-- 1 root root 2817 9月 24 15:18 /etc/passwd

可以看到 passwd 文件只有对于 root 用户是可写的，而对于所有的他用户来说都是没有写权限的。 那么一个普通的用户如何能够通过运行 passwd 命令修改这个 passwd 文件呢？为了解决这个问题，SUID/SGID 便应运而生。 
SUID 和 SGID 是如何解决这个问题呢？ 
首先，我们要知道：进程在运行的时候，有一些属性，其中包括 实际用户ID,实际组ID,有效用户ID,有效组ID等。 **实际用户ID和实际组ID标识我们是谁，谁在运行这个程序,一般这2个字段在登陆时决定，在一个登陆会话期间， 这些值基本上不改变。 而有效用户ID和有效组ID则决定了进程在运行时的权限。内核在决定进程是否有文件存取权限时，是采用了进程的有效用户ID来进行判断的。** 
当一个程序设置了为SUID位时，内核就知道了运行这个程序的时候，应该认为是文件的所有者在运行这个程序。即该程序运行的时候，有效用户ID是该程序的所有者。 
在设置了SUID后，passwd的权限如下： 
>-rwsr-xr-x 1 root root 47032 2月 17 2014 /usr/bin/passwd

虽然我们是以普通用户的方式登录的，但是由于设置了SUID，故进程的有效用户ID则是passwd文件的所有者root的ID，因此可以修改/etc/passwd文件。类似的还有ping、su、mount、umount等

SUID 虽然很好了解决了一些问题，但是同时也会带来一些安全隐患。 因为设置了 SUID 位的程序如果被攻击(通过缓冲区溢出等方面),那么 hacker 就可以拿到 root 权限。 因此在安全方面特别要注意那些设置了 SUID 的程序。